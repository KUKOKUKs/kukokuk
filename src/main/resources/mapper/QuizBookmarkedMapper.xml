<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kukokuk.mapper.QuizBookmarkedMapper">

    <resultMap id="QuizBookmarkedMap" type="QuizBookmarked">
        <id property="bookmarkNo" column="BOOKMARK_NO"/>
        <result property="userNo" column="USER_NO"/>
        <result property="quizNo" column="QUIZ_NO"/>
        <result property="createdDate" column="CREATED_DATE"/>
    </resultMap>

    <!--
        * 북마크 단건 조회(유저+퀴즈 기준)
        * @param userNo 사용자 번호
        * @param quizNo 퀴즈 번호
        * @return QuizBookmarked 객체 (없으면 null)
    -->
    <select id="getQuizBookmarkedByUserNoAndQuizNo" resultMap="QuizBookmarkedMap">
        SELECT BOOKMARK_NO, USER_NO, QUIZ_NO, CREATED_DATE
        FROM KUKOKUK_QUIZ_BOOKMARKED
        WHERE USER_NO = #{userNo}
          AND QUIZ_NO = #{quizNo}
    </select>

    <!--
        * 북마크 등록
        * @param quizBookmarked 북마크 객체
        * @return int (등록된 row 수)
    -->
    <insert id="insertQuizBookmarked" parameterType="QuizBookmarked">
        INSERT INTO KUKOKUK_QUIZ_BOOKMARKED
            (USER_NO, QUIZ_NO, CREATED_DATE)
        VALUES (#{userNo}, #{quizNo}, NOW())
    </insert>

    <!--
        * 북마크 삭제
        * @param userNo 사용자 번호
        * @param quizNo 퀴즈 번호
        * @return int (삭제된 row 수)
    -->
    <delete id="deleteQuizBookmarkedByUserNoAndQuizNo">
        DELETE
        FROM KUKOKUK_QUIZ_BOOKMARKED
        WHERE USER_NO = #{userNo}
          AND QUIZ_NO = #{quizNo}
    </delete>

    <!--
        * 해당 사용자의 전체 북마크 리스트 조회
        * @param userNo 사용자 번호
        * @return List<QuizBookmarked>
    -->
    <select id="getQuizBookmarkedListByUserNo" resultMap="QuizBookmarkedMap">
        SELECT BOOKMARK_NO, USER_NO, QUIZ_NO, CREATED_DATE
        FROM KUKOKUK_QUIZ_BOOKMARKED
        WHERE USER_NO = #{userNo}
        ORDER BY CREATED_DATE DESC
    </select>

    <!--
    * 해당 사용자의 북마크 퀴즈 목록 조회 (페이징)
    * @param userNo 사용자 번호
    * @param offset 시작 위치
    * @param limit 조회 개수
    * @return List<BookmarkedQuizDto>
-->
    <select id="getBookmarkedQuizzes" resultType="BookmarkedQuizDto">
        SELECT
            b.BOOKMARK_NO,
            b.QUIZ_NO,
            b.CREATED_DATE,
            q.QUESTION,
            q.OPTION1,
            q.OPTION2,
            q.OPTION3,
            q.OPTION4,
            q.QUESTION_TYPE,
            q.DIFFICULTY,
            q.USAGE_COUNT,
            q.SUCCESS_COUNT,
            q.ACCURACY_RATE
        FROM KUKOKUK_QUIZ_BOOKMARKED b
                 JOIN KUKOKUK_QUIZ_MASTERS q
                      ON b.QUIZ_NO = q.QUIZ_NO
        WHERE b.USER_NO = #{userNo}
        ORDER BY b.CREATED_DATE DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!--
        * 해당 사용자의 북마크 퀴즈 총 개수 조회
        * @param userNo 사용자 번호
        * @return int (북마크된 퀴즈 개수)
    -->
    <select id="getCountBookmarkedQuizzes" resultType="int">
        SELECT COUNT(*)
        FROM KUKOKUK_QUIZ_BOOKMARKED
        WHERE USER_NO = #{userNo}
    </select>

</mapper>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kukokuk.mapper.QuizSessionSummaryMapper">

    <!--
        퀴즈 세션 요약 resultMap
        DB 컬럼명(snake_case)과 VO 필드명(camelCase)을 명시적으로 매핑한다.
    -->
    <resultMap id="quizSessionSummaryMap" type="QuizSessionSummary">
        <id property="sessionNo" column="SESSION_NO"/>
        <result property="userNo" column="USER_NO"/>
        <result property="totalQuestion" column="TOTAL_QUESTION"/>
        <result property="totalTimeSec" column="TOTAL_TIME_SEC"/>
        <result property="correctAnswers" column="CORRECT_ANSWERS"/>
        <result property="percentile" column="PERCENTILE"/>
        <result property="averageTimePerQuestion" column="AVERAGE_TIME_PER_QUESTION"/>
        <result property="createdDate" column="CREATED_DATE"/>
        <result property="updatedDate" column="UPDATED_DATE"/>
    </resultMap>

    <!--
        퀴즈 세션 요약 정보를 저장한다.
        INSERT 후 자동 증가된 sessionNo를 VO에 주입한다.

        @param summary 저장할 퀴즈 세션 요약 객체
        @return insert된 행 수 (성공 시 1)
    -->
    <insert id="insertQuizSessionSummary" parameterType="QuizSessionSummary"
      useGeneratedKeys="true" keyProperty="sessionNo">
        INSERT INTO KUKOKUK_QUIZ_SESSION_SUMMARIES (
            USER_NO,
            TOTAL_QUESTION,
            TOTAL_TIME_SEC,
            CORRECT_ANSWERS,
            PERCENTILE,
            AVERAGE_TIME_PER_QUESTION,
            CREATED_DATE
        )
        VALUES (
                   #{userNo},
                   #{totalQuestion},
                   #{totalTimeSec},
                   #{correctAnswers},
                   #{percentile},
                   #{averageTimePerQuestion},
                   NOW()
               )
    </insert>

    <!--
        퀴즈 세션 요약 정보를 수정한다.
        총 정답 수와 평균 시간 등을 세션 완료 후 갱신한다.

        @param summary 수정할 퀴즈 세션 요약 객체
        @return 수정된 행 수 (성공 시 1)
    -->
    <update id="updateQuizSessionSummary" parameterType="QuizSessionSummary">
        UPDATE KUKOKUK_QUIZ_SESSION_SUMMARIES
        SET CORRECT_ANSWERS = #{correctAnswers},
            AVERAGE_TIME_PER_QUESTION = #{averageTimePerQuestion}
        WHERE SESSION_NO = #{sessionNo}
    </update>

    <!--
        세션 번호와 유저 번호로 퀴즈 세션 요약 정보를 조회한다.
        결과 화면에 표시할 요약 정보를 가져올 때 사용한다.

        @param sessionNo 세션 번호
        @param userNo 사용자 번호
        @return 조회된 QuizSessionSummary 객체, 없으면 null
    -->
    <select id="getSummaryBySessionNoAndUserNo"
      resultMap="quizSessionSummaryMap">
        SELECT *
        FROM KUKOKUK_QUIZ_SESSION_SUMMARIES
        WHERE SESSION_NO = #{sessionNo}
          AND USER_NO = #{userNo}
    </select>

    <!--
     * 같은 정답 수(correctAnswers)를 가진 세션 수를 조회한다.
     *
     * @param correctAnswers 정답 개수
     * @return 해당 정답 수를 가진 세션 수
    -->
    <select id="getCountSameSessions" resultType="int">
        SELECT COUNT(*)
        FROM KUKOKUK_QUIZ_SESSION_SUMMARIES
        WHERE CORRECT_ANSWERS = #{correctAnswers}
    </select>

    <!--
     * 같은 정답 수이면서 평균 시간이 나보다 긴 세션 수를 조회한다.
     *
     * @param correctAnswers 정답 개수
     * @param averageTime 평균 소요 시간
     * @return 나보다 느린 세션 수
    -->
    <select id="getCountSlowerSessions" resultType="int">
        SELECT COUNT(*)
        FROM KUKOKUK_QUIZ_SESSION_SUMMARIES
        WHERE CORRECT_ANSWERS = #{correctAnswers}
          AND AVERAGE_TIME_PER_QUESTION > #{averageTime}
    </select>

</mapper>

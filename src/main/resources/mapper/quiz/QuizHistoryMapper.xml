<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kukokuk.domain.quiz.mapper.QuizHistoryMapper">

    <!--
        퀴즈 이력 DTO
        DB 컬럼명과 DTO 필드명을 명시적으로 매핑한다.
    -->
    <resultMap id="quizHistoryMap" type="QuizHistoryDto">
        <result property="sessionNo" column="SESSION_NO"/>
        <result property="userNo" column="USER_NO"/>
        <result property="gameType" column="GAME_TYPE"/>
        <result property="score" column="SCORE"/>
        <result property="playTime" column="PLAY_TIME"/>
        <result property="createdDate" column="CREATED_DATE"/>
        <result property="difficulty" column="DIFFICULTY"/>
        <result property="questionType" column="QUESTION_TYPE"/>
    </resultMap>

    <!--
        사용자 번호로 스피드 퀴즈 최근 이력을 조회한다.
        최근 생성일 기준으로 내림차순 정렬하여 지정된 개수만큼 조회한다.

        @param userNo 사용자 번호
        @param limit 조회할 개수
        @return 스피드 퀴즈 이력 리스트
    -->
    <select id="getSpeedHistoryByUserNoWithLimit" resultMap="quizHistoryMap">
        SELECT
            SESSION_NO,
            USER_NO,
            'speed' as GAME_TYPE,
            CORRECT_ANSWERS as SCORE,
            TOTAL_TIME_SEC as PLAY_TIME,
            CREATED_DATE,
            NULL as DIFFICULTY,
            NULL as QUESTION_TYPE
        FROM KUKOKUK_QUIZ_SESSION_SUMMARIES
        WHERE USER_NO = #{userNo}
          AND QUIZ_MODE = 'speed'
        ORDER BY CREATED_DATE DESC
        LIMIT #{limit}
    </select>

    <!--
        사용자 번호로 단계별 퀴즈 최근 이력을 조회한다.
        최근 생성일 기준으로 내림차순 정렬하여 지정된 개수만큼 조회한다.
        QUIZ_RESULTS와 QUIZ_MASTERS를 조인하여 난이도와 문제유형을 가져온다.

        @param userNo 사용자 번호
        @param limit 조회할 개수
        @return 단계별 퀴즈 이력 리스트
    -->
    <select id="getLevelHistoryByUserNoWithLimit" resultMap="quizHistoryMap">
        SELECT DISTINCT
            qs.SESSION_NO,
            qs.USER_NO,
            'level' as GAME_TYPE,
            qs.CORRECT_ANSWERS as SCORE,
            qs.TOTAL_TIME_SEC as PLAY_TIME,
            qs.CREATED_DATE,
            qm.DIFFICULTY,
            qm.QUESTION_TYPE
        FROM KUKOKUK_QUIZ_SESSION_SUMMARIES qs
                 JOIN KUKOKUK_QUIZ_RESULTS qr ON qs.SESSION_NO = qr.SESSION_NO
                 JOIN KUKOKUK_QUIZ_MASTERS qm ON qr.QUIZ_NO = qm.QUIZ_NO
        WHERE qs.USER_NO = #{userNo}
          AND qs.QUIZ_MODE = 'level'
        ORDER BY qs.CREATED_DATE DESC
        LIMIT #{limit}
    </select>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kukokuk.domain.quiz.mapper.QuizResultMapper">

    <!-- ê²°ê³¼ VO ë§¤í•‘ -->
    <resultMap id="quizResultMap" type="QuizResult">
        <id property="resultNo" column="RESULT_NO"/>
        <result property="accuracyRate" column="ACCURACY_RATE"/>
        <result property="sessionNo" column="SESSION_NO"/>
        <result property="selectedChoice" column="SELECTED_CHOICE"/>
        <result property="isSuccess" column="IS_SUCCESS"/>
        <result property="createdDate" column="CREATED_DATE"/>
        <result property="updatedDate" column="UPDATED_DATE"/>
        <result property="userNo" column="USER_NO"/>
        <result property="quizNo" column="QUIZ_NO"/>
    </resultMap>

    <!-- í€´ì¦ˆ ê²°ê³¼ ì €ìž¥ -->
    <insert id="insertQuizResult" parameterType="QuizResult">
        INSERT INTO KUKOKUK_QUIZ_RESULTS
        (SESSION_NO,
         SELECTED_CHOICE,
         IS_SUCCESS,
         USER_NO,
         QUIZ_NO)
        VALUES (#{sessionNo},
                #{selectedChoice},
                #{isSuccess},
                #{userNo},
                #{quizNo})
    </insert>

    <!-- í€´ì¦ˆ ì‚¬ìš© íšŸìˆ˜ ì¦ê°€ -->
    <update id="updateUsageCount" parameterType="int">
        UPDATE KUKOKUK_QUIZ_MASTERS
        SET USAGE_COUNT = USAGE_COUNT + 1
        WHERE QUIZ_NO = #{quizNo}
    </update>

    <!-- í€´ì¦ˆ ì •ë‹µ íšŸìˆ˜ ì¦ê°€ -->
    <update id="updateSuccessCount" parameterType="int">
        UPDATE KUKOKUK_QUIZ_MASTERS
        SET SUCCESS_COUNT = SUCCESS_COUNT + 1
        WHERE QUIZ_NO = #{quizNo}
    </update>

    <!--
     * ì„¸ì…˜ ë²ˆí˜¸ì™€ ì‚¬ìš©ìž ë²ˆí˜¸ë¡œ í‘¼ í€´ì¦ˆ ê²°ê³¼ë¥¼ ì¡°íšŒí•œë‹¤.
     * ðŸ”§ ìˆ˜ì •: ë¶ë§ˆí¬ ì •ë³´ í¬í•¨í•˜ì—¬ ì¡°íšŒ
     * @param sessionNo ì„¸ì…˜ ë²ˆí˜¸
     * @param userNo    ì‚¬ìš©ìž ë²ˆí˜¸
     * @return í€´ì¦ˆ ê²°ê³¼ ì‘ë‹µ ë¦¬ìŠ¤íŠ¸
    -->
    <select id="getQuizResultsBySession"
        parameterType="map"
        resultType="com.kukokuk.domain.quiz.dto.QuizResultDto">
        SELECT
        qm.QUIZ_NO AS quizNo,
        qm.QUESTION AS question,
        qm.OPTION1 AS option1,
        qm.OPTION2 AS option2,
        qm.OPTION3 AS option3,
        qm.OPTION4 AS option4,
        qr.SELECTED_CHOICE AS selectedChoice,
        qm.SUCCESS_ANSWER AS successAnswer,
        qr.IS_SUCCESS AS isSuccess,
        qm.QUESTION_TYPE AS questionType,
        <!-- ðŸ”§ ì¶”ê°€: ë¶ë§ˆí¬ ì—¬ë¶€ ì¡°íšŒ -->
        CASE WHEN qb.QUIZ_NO IS NOT NULL THEN 'Y' ELSE 'N' END AS bookmarked
        FROM KUKOKUK_QUIZ_RESULTS qr
        JOIN KUKOKUK_QUIZ_MASTERS qm ON qr.QUIZ_NO = qm.QUIZ_NO
        <!-- ðŸ”§ ì¶”ê°€: ë¶ë§ˆí¬ í…Œì´ë¸”ê³¼ LEFT JOIN -->
        LEFT JOIN KUKOKUK_QUIZ_BOOKMARKED qb ON qr.QUIZ_NO = qb.QUIZ_NO AND qb.USER_NO = #{userNo}
        WHERE qr.SESSION_NO = #{sessionNo}
        AND qr.USER_NO = #{userNo}
        ORDER BY qr.RESULT_NO ASC
    </select>

    <!-- ì •ë‹µë¥ (ACCURACY_RATE) ê°±ì‹  -->
    <update id="updateAccuracyRate" parameterType="int">
        UPDATE KUKOKUK_QUIZ_MASTERS
        SET ACCURACY_RATE =
                CASE
                    WHEN USAGE_COUNT = 0 THEN 0
                    ELSE (SUCCESS_COUNT * 100.0 / USAGE_COUNT)
                    END
        WHERE QUIZ_NO = #{quizNo}
    </update>

    <!-- ë‚œì´ë„ ìžë™ ê°±ì‹  -->
    <update id="updateDifficulty" parameterType="int">
        UPDATE KUKOKUK_QUIZ_MASTERS
        SET DIFFICULTY =
                CASE
                    WHEN ACCURACY_RATE &lt;= 30 THEN 'ì–´ë ¤ì›€'
                    WHEN ACCURACY_RATE &gt; 30 AND ACCURACY_RATE &lt;= 60 THEN 'ë³´í†µ'
                    WHEN ACCURACY_RATE &gt; 60 THEN 'ì‰¬ì›€'
                    END
        WHERE QUIZ_NO = #{quizNo}
    </update>

</mapper>
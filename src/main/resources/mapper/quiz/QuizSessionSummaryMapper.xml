<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kukokuk.domain.quiz.mapper.QuizSessionSummaryMapper">

    <!--
        퀴즈 세션 요약
        DB 컬럼명과 VO 필드명을 명시적으로 매핑한다.
    -->
    <resultMap id="quizSessionSummaryMap" type="QuizSessionSummary">
        <id property="sessionNo" column="SESSION_NO"/>
        <result property="userNo" column="USER_NO"/>
        <result property="totalQuestion" column="TOTAL_QUESTION"/>
        <result property="totalTimeSec" column="TOTAL_TIME_SEC"/>
        <result property="correctAnswers" column="CORRECT_ANSWERS"/>
        <result property="percentile" column="PERCENTILE"/>
        <result property="averageTimePerQuestion" column="AVERAGE_TIME_PER_QUESTION"/>
        <result property="quizMode" column="QUIZ_MODE"/>
        <result property="difficulty" column="DIFFICULTY"/>
        <result property="createdDate" column="CREATED_DATE"/>
        <result property="updatedDate" column="UPDATED_DATE"/>
    </resultMap>

    <!--
         * 사용자의 특정 컨텐츠타입의 최신 세션 목록 정보 조회
         * @param userNo 사용자 번호
         * @param quizMode 조회할 퀴즈모드
         * @param sessionCount 조회할 개수
         * @return 최근 등록 정렬된 세션 목록 정보
        List<QuizSessionSummary> getQuizSessionSummaryByUserNoAndMode(
            @Param("userNo") int userNo
            , @Param("quizMode") String quizMode
            , @Param("sessionCount") int sessionCount);
    -->
    <select id="getQuizSessionSummaryByUserNoAndMode" resultMap="quizSessionSummaryMap">
        SELECT S.SESSION_NO
             , S.USER_NO
             , S.TOTAL_QUESTION
             , S.TOTAL_TIME_SEC
             , S.CORRECT_ANSWERS
             , S.PERCENTILE
             , S.AVERAGE_TIME_PER_QUESTION
             , S.QUIZ_MODE
             , S.CREATED_DATE
             , S.UPDATED_DATE
             , IF(S.QUIZ_MODE = 'level', (SELECT DISTINCT M.DIFFICULTY
                                          FROM KUKOKUK_QUIZ_RESULTS R
                                                   JOIN KUKOKUK_QUIZ_MASTERS M ON R.QUIZ_NO = M.QUIZ_NO
                                          WHERE R.SESSION_NO = S.SESSION_NO
                                          LIMIT 1), NULL) AS DIFFICULTY
        FROM KUKOKUK_QUIZ_SESSION_SUMMARIES S
        WHERE S.USER_NO = #{userNo}
          AND S.QUIZ_MODE = #{quizMode}
        ORDER BY S.UPDATED_DATE DESC
        LIMIT #{sessionCount}
    </select>

    <!--
        퀴즈 세션 요약 정보를 저장한다.
        INSERT 후 자동 증가된 sessionNo를 VO에 주입한다.

        @param summary 저장할 퀴즈 세션 요약 객체
        @return insert된 행 수 (성공 시 1)
    -->
    <insert id="insertQuizSessionSummary" parameterType="QuizSessionSummary"
        useGeneratedKeys="true" keyProperty="sessionNo">
        INSERT INTO KUKOKUK_QUIZ_SESSION_SUMMARIES
        (USER_NO,
         TOTAL_QUESTION,
         TOTAL_TIME_SEC,
         CORRECT_ANSWERS,
         PERCENTILE,
         AVERAGE_TIME_PER_QUESTION,
         QUIZ_MODE,
         CREATED_DATE)
        VALUES (#{userNo},
                #{totalQuestion},
                #{totalTimeSec},
                #{correctAnswers},
                #{percentile},
                #{averageTimePerQuestion},
                #{quizMode},
                NOW())
    </insert>

    <!--
        퀴즈 세션 요약 정보를 수정한다.
        총 정답 수와 평균 시간 등을 세션 완료 후 갱신한다.

        @param summary 수정할 퀴즈 세션 요약 객체
        @return 수정된 행 수 (성공 시 1)
    -->
    <update id="updateQuizSessionSummary" parameterType="QuizSessionSummary">
        UPDATE KUKOKUK_QUIZ_SESSION_SUMMARIES
        SET CORRECT_ANSWERS           = #{correctAnswers},
            AVERAGE_TIME_PER_QUESTION = #{averageTimePerQuestion},
            PERCENTILE                = #{percentile}
        WHERE SESSION_NO = #{sessionNo}
    </update>


    <!--
        세션 번호와 유저 번호로 퀴즈 세션 요약 정보를 조회한다.
        결과 화면에 표시할 요약 정보를 가져올 때 사용한다.

        @param sessionNo 세션 번호
        @param userNo 사용자 번호
        @return 조회된 QuizSessionSummary 객체, 없으면 null
    -->
    <select id="getSummaryBySessionNoAndUserNo"
        resultMap="quizSessionSummaryMap">
        SELECT *
        FROM KUKOKUK_QUIZ_SESSION_SUMMARIES
        WHERE SESSION_NO = #{sessionNo}
          AND USER_NO = #{userNo}
    </select>
    <!--
            나보다 성적이 좋은(정답 수가 많거나, 정답 수는 같고 평균 시간이 더 짧은) 세션 수 조회
            @param correctAnswers 내 정답 수
            @param averageTime    내 평균 풀이 시간
            @return 나보다 앞선 세션 수
        -->
    <select id="getCountBetterSessions" resultType="int">
        SELECT COUNT(*)
        FROM KUKOKUK_QUIZ_SESSION_SUMMARIES
        WHERE QUIZ_MODE = 'speed'
          AND (
            CORRECT_ANSWERS &gt; #{correctAnswers}
                OR (CORRECT_ANSWERS = #{correctAnswers}
                AND AVERAGE_TIME_PER_QUESTION &lt; #{averageTimePerQuestion})
            )
    </select>

    <!--
        전체 세션 수 조회
        @return 전체 세션 수
    -->
    <select id="getTotalSessionCount" resultType="int">
        SELECT COUNT(*)
        FROM KUKOKUK_QUIZ_SESSION_SUMMARIES
        WHERE QUIZ_MODE = 'speed'
    </select>

</mapper>

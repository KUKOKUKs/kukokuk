<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/center}">

<div layout:fragment="content">

    <!--/* ì™¼ìª½ í€´ì¦ˆ ì˜ì—­ */-->
    <div class="quiz_area">
        <div class="study_quiz_wrapper">
            <!-- í€´ì¦ˆ ë²ˆí˜¸ ë° ì œëª© -->
            <div class="study_quiz_info">
                <div class="icon_btn primary">
                    <iconify-icon icon="line-md:question-circle-twotone"></iconify-icon>
                </div>
                <span class="study_quiz_text">ë¬¸ì œ</span>
            </div>

            <!-- ë¬¸ì œ ë°•ìŠ¤ -->
            <div class="study_quiz_box"
                th:text="${data.essay.question}"></div>

            <!-- ë³´ê¸° ë¦¬ìŠ¤íŠ¸ -->
            <div class="study_quiz_option_wrapper">
                <div class="study_quiz_info">
                    <div class="icon_btn">
                        <iconify-icon icon="line-md:pencil-twotone"></iconify-icon>
                    </div>
                    <span class="study_quiz_text">ë‹µë³€í•˜ê¸°</span>
                </div>
            </div>

            <!--/* ë‹µë³€ ë°•ìŠ¤ */-->
            <textarea class="study_quiz_box answer" id="essay-answer-input" th:text="${data.essayLog != null ? data.essayLog.userAnswer : ''}">

            </textarea>

            <!--/* ë²„íŠ¼  */-->
            <div class="btn_list">
                <button type="button" class="btn primary d_flex tiny_gap" id="essay-feedback-btn">
                    <div class="icon_btn">
                        <iconify-icon icon="mingcute:ai-fill"></iconify-icon>
                    </div>
                    AI í”¼ë“œë°±
                </button>
                <button type="button" class="btn white" id="essay-save-btn">ì„ì‹œì €ì¥í•˜ê¸°</button>
            </div>

            <div class="d_flex justify_content_end">
                <a href="/study" type="button" class="btn small gray">ëŒì•„ê°€ê¸°</a>
            </div>
        </div>
    </div>

    <!--/* ì˜¤ë¥¸ìª½ í”¼ë“œë°± ì˜ì—­ */-->
    <div class="feedback_area">
        <div class="essay_feedback_container">
            <div class="feedback_title">
                AI í”¼ë“œë°±
            </div>
            <div id="essay-feedback-box-container" class="essay_feedback_box_container">
                <!-- AI í”¼ë“œë°±ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë˜ì–´ ì¶”ê°€í•˜ëŠ” ë¶€ë¶„ -->
            </div>
        </div>
    </div>

</div>

<script layout:fragment="script" th:inline="javascript">
    /*<![CDATA[*/

    //SSRë¡œ ì¡°íšŒí•œ data.essayLogì—ì„œ dailyStudyEssayQuizLogNoë¥¼ ë³€ìˆ˜ë¡œ ì €ì¥í•´ë†“ê¸°
    let essayQuizLogNo  = /*[[${data.essayLog?.dailyStudyEssayQuizLogNo}]]*/ null;
    const essayQuizNo = /*[[${data.essay?.dailyStudyEssayQuizNo}]]*/ null;
    const essayQuizLogAiFeedback = /*[[${data.essayLog?.aiFeedback}]]*/ null;

    const $answerInput = $('#essay-answer-input');
    const $aiFeedbackContainer = $('#essay-feedback-box-container');

    $(document).ready(function() {
        if(essayQuizLogAiFeedback != null){
            const feedbackData = (typeof essayQuizLogAiFeedback === 'string')
                ? JSON.parse(essayQuizLogAiFeedback)
                : essayQuizLogAiFeedback;

            $('.content').removeClass('center').addClass('show_essay_feedback');
            renderAiFeedback(feedbackData);
        }
    });

    /**
     * AI í”¼ë“œë°± ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ë™ì‘í•˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë©”ì†Œë“œ
     */
    $('#essay-feedback-btn').click(function() {

        const userAnswer = $answerInput.val().trim();
        if (!userAnswer) {
            alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')
            return;
        }

        // ì˜¤ë¥¸ìª½ í”¼ë“œë°± ì°½ì´ ì—´ë¦¬ë„ë¡ ì„¤ì •
        $('.content').removeClass('center');
        $('.content').addClass('show_essay_feedback');

        // ì‘ë‹µë°›ê¸° ì „ê¹Œì§€ ë¡œë”©í‘œì‹œ ì¶”ê°€
        $aiFeedbackContainer.html(`
            <div class="loading_spinner">
                <div class="spinner"></div>
                <div class="info_text">AI í”¼ë“œë°± ìƒì„± ì¤‘...</div>
            </div>
        `);

        // dailyStudyEssayQuizLogNoê°€ nullì´ ì•„ë‹ˆë¼ë©´ ìš”ì²­ë°”ë””ì— í¬í•¨
        // nullì´ë©´ í¬í•¨í•˜ì§€ì•Šê³  AIìš”ì²­
        const requestBody = {
            dailyStudyEssayQuizLogNo: essayQuizLogNo, // nullì´ë©´ í¬í•¨ë˜ì§€ ì•ŠìŒ
            dailyStudyEssayQuizNo: essayQuizNo,
            userAnswer: userAnswer
        };

        $.ajax({
            url: '/api/studies/essays/ai',
            method: 'PUT',
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify(requestBody),
            success: function(res) {
                console.log(res);

                renderAiFeedback(res.data);
            },
            error: function(err) {
                alert('í”¼ë“œë°± ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”');
                $aiFeedbackContainer.empty().html(`
                <div class="info_text">í”¼ë“œë°± ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”, ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
                `);
            }
        })
    })

    /**
     * ì €ì¥í•˜ê¸° ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ë™ì‘í•˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë©”ì†Œë“œ
     */
    $('#essay-save-btn').click(function() {
        const userAnswer = $answerInput.val().trim();
        if (!userAnswer) {
            alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')
            return;
        }

        // essayQuizLogNoê°€ nullì´ë©´ ìƒì„± ìš”ì²­ í˜¸ì¶œ,
        // nullì´ ì•„ë‹ˆë©´ ì„œìˆ í˜•í€´ì¦ˆ ì´ë ¥ ìˆ˜ì • ìš”ì²­ í˜¸ì¶œ
        const isUpdate = (essayQuizLogNo != null);
        const url = isUpdate ? `/api/studies/essays/logs/${essayQuizLogNo}` : `/api/studies/essays/logs`;
        const method = isUpdate ? 'PUT' : 'POST';
        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify({
                dailyStudyEssayQuizNo: essayQuizNo,
                userAnswer : userAnswer
            }),
            success: function(res) {
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                console.log(res);

                // ìƒˆë¡œìƒì„±ëœ ì„œìˆ í˜• ì´ë ¥ì´ë©´ ê·¸ ì‹ë³„ì ë²ˆí˜¸ë¥¼ JS ë³€ìˆ˜ì— ì €ì¥
                essayQuizLogNo = essayQuizLogNo != null ? essayQuizLogNo : res.dailyStudyEssayQuizLogNo;
            }
        })
    })

    /**
     * AI í”¼ë“œë°±ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
     * @param data
     * data í˜•ì‹
     * "sections": [
     *       {
     *         "type": "summary",
     *         "title": "ì´í‰",
     *         "items": [
     *           {
     *             "extra": {"icon": 'ğŸ‘'},
     *             "text": "ë‹µë³€ì´ ë§¤ìš° ì§§ê³ , ë¬¸ì œì—ì„œ ìš”êµ¬í•˜ëŠ” ë‚´ìš©ì„ ê±°ì˜ í¬í•¨í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. 'ì—ë¸Œë¦¬ì”½ ì—ë¸Œë¦¬ì› ì˜¬ ì•³ ì›ìŠ¤'ë¼ëŠ” ì¢‹ì•„í•˜ëŠ” ì˜í™”ë¥¼ ì œì‹œí–ˆì§€ë§Œ, ë“±ì¥ì¸ë¬¼, ì‚¬ê±´, ì‹œê°„ ìˆœì„œëŒ€ë¡œ ì •ë¦¬í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜í™”ì˜ ìˆœì„œë¥¼ ëª¨ë¥¸ë‹¤ëŠ” ì ì„ ì†”ì§í•˜ê²Œ ë°í˜”ì§€ë§Œ, ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì¶”ê°€ì ì¸ ë…¸ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤."
     *           }
     *         ]
     *       },
     *     ]
     */
    function renderAiFeedback(data) {
        $aiFeedbackContainer.empty();

        data.sections.forEach((section, idx) => {
            let itemHtml = '';
            section.items.forEach(item => {
                if(item.text != null) {
                    itemHtml += `<div>
                        ${item.text}
                    </div>`;
                }
            })

            const sectionHtml = `
                <div class="component essay_feedback_box">
                    <div class="title">
                        <span>${section.icon ? section.icon : ''} </span>
                        ${section.title}
                    </div>
                    ${itemHtml}
                </div>
            `;

            // ë¬¸ìì—´ì„ jQuery ê°ì²´ë¡œ ë³€í™˜
            const $sectionEl = $(sectionHtml);

            // CSS ë³€ìˆ˜ --delayë¡œ ì¹´ë“œë³„ ë”œë ˆì´ ì§€ì • (0s, 1s, 2s...)
            $sectionEl.css('--delay', `${idx * 1}s`);

            // DOMì— ì¶”ê°€
            $aiFeedbackContainer.append($sectionEl);

            // ê°•ì œ ë¦¬í”Œë¡œìš°
            // jQueryê°ì²´ì—ì„œ [0]ì€ ìˆœìˆ˜ DOM Element
            // .offsetHeightëŠ” DOMìš”ì†Œì˜ ë Œë”ë§ëœ ë†’ì´ë¥¼ í”½ì…€ë‹¨ìœ„ë¡œ ë°˜í™˜
            // ì—¬ê¸°ì„œ ê°’ì„ ì½ëŠ” ê²ƒ ìì²´ë¡œ ì§€ê¸ˆê¹Œì§€ì˜ ëª¨ë“  ìŠ¤íƒ€ì¼ ê³„ì‚°ê³¼ ë ˆì´ì•„ì›ƒ ì‘ì—…ì´ ì™„ë£Œë¨
            // ë¸Œë¼ìš°ì €ê°€ revealì´ ë°˜ì˜ë˜ì§€ ì•Šì€ ì´ˆê¸°ìƒíƒœì˜ ìš”ì†Œë¥¼ í™”ë©´ì— ë¨¼ì € ë°˜ì˜í•˜ë„ë¡ í•¨
            $sectionEl[0].offsetHeight;

            // í´ë˜ìŠ¤ ë¶€ì—¬ë¡œ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            $sectionEl.addClass('reveal');
        })
    }

    /*]]>*/
</script>

</html>
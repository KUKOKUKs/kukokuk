<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/center}">

<div layout:fragment="content">

    <!--/* ÏôºÏ™Ω ÌÄ¥Ï¶à ÏòÅÏó≠ */-->
    <div class="quiz_area">
        <div class="study_quiz_wrapper">
            <!-- ÌÄ¥Ï¶à Î≤àÌò∏ Î∞è Ï†úÎ™© -->
            <div class="study_quiz_info">
                <div class="icon_btn primary">
                    <iconify-icon icon="line-md:question-circle-twotone"></iconify-icon>
                </div>
                <span class="study_quiz_text">Î¨∏Ï†ú</span>
            </div>

            <!-- Î¨∏Ï†ú Î∞ïÏä§ -->
            <div class="study_quiz_box"
                th:text="${data.essay.question}"></div>

            <!-- Î≥¥Í∏∞ Î¶¨Ïä§Ìä∏ -->
            <div class="study_quiz_option_wrapper">
                <div class="study_quiz_info">
                    <div class="icon_btn">
                        <iconify-icon icon="line-md:pencil-twotone"></iconify-icon>
                    </div>
                    <span class="study_quiz_text">ÎãµÎ≥ÄÌïòÍ∏∞</span>
                </div>
            </div>

            <!--/* ÎãµÎ≥Ä Î∞ïÏä§ */-->
            <textarea class="study_quiz_box answer" id="essay-answer-input" th:text="${data.essayLog != null ? data.essayLog.userAnswer : ''}">

            </textarea>

            <!--/* Î≤ÑÌäº  */-->
            <div class="btn_list">
                <button type="button" class="btn primary d_flex tiny_gap" id="essay-feedback-btn">
                    <div class="icon_btn">
                        <iconify-icon icon="mingcute:ai-fill"></iconify-icon>
                    </div>
                    AI ÌîºÎìúÎ∞±
                </button>
                <button type="button" class="btn white" id="essay-save-btn">ÏûÑÏãúÏ†ÄÏû•ÌïòÍ∏∞</button>
            </div>

            <div class="d_flex justify_content_end">
                <a href="/study" type="button" class="btn small gray">ÎèåÏïÑÍ∞ÄÍ∏∞</a>
            </div>
        </div>
    </div>

    <!--/* Ïò§Î•∏Ï™Ω ÌîºÎìúÎ∞± ÏòÅÏó≠ */-->
    <div class="feedback_area">
        <div class="essay_feedback_container">
            <div class="feedback_title">
                AI ÌîºÎìúÎ∞±
            </div>
            <div id="essay-feedback-box-container" class="essay_feedback_box_container">
                <!-- AI ÌîºÎìúÎ∞±Ïù¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏñ¥ Ï∂îÍ∞ÄÌïòÎäî Î∂ÄÎ∂Ñ -->
            </div>
        </div>
    </div>

</div>

<script layout:fragment="script" th:inline="javascript">
    /*<![CDATA[*/

    //SSRÎ°ú Ï°∞ÌöåÌïú data.essayLogÏóêÏÑú dailyStudyEssayQuizLogNoÎ•º Î≥ÄÏàòÎ°ú Ï†ÄÏû•Ìï¥ÎÜìÍ∏∞
    let essayQuizLogNo  = /*[[${data.essayLog?.dailyStudyEssayQuizLogNo}]]*/ null;
    const essayQuizNo = /*[[${data.essay?.dailyStudyEssayQuizNo}]]*/ null;
    const essayQuizLogAiFeedback = /*[[${data.essayLog?.aiFeedback}]]*/ null;

    const $answerInput = $('#essay-answer-input');
    const $aiFeedbackContainer = $('#essay-feedback-box-container');

    $(document).ready(function() {
        if(essayQuizLogAiFeedback != null){
            const feedbackData = (typeof essayQuizLogAiFeedback === 'string')
                ? JSON.parse(essayQuizLogAiFeedback)
                : essayQuizLogAiFeedback;

            $('.content').removeClass('center').addClass('show_essay_feedback');
            renderAiFeedback(feedbackData);
        }
    });

    /**
     * AI ÌîºÎìúÎ∞± Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå ÎèôÏûëÌïòÎäî Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Î©îÏÜåÎìú
     */
    $('#essay-feedback-btn').click(function() {

        // Ïò§Î•∏Ï™Ω ÌîºÎìúÎ∞± Ï∞ΩÏù¥ Ïó¥Î¶¨ÎèÑÎ°ù ÏÑ§Ï†ï
        $('.content').removeClass('center');
        $('.content').addClass('show_essay_feedback');

        const userAnswer = $answerInput.val().trim();
        if (!userAnswer) {
            alert('ÎãµÎ≥ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.')
            return;
        }
        // dailyStudyEssayQuizLogNoÍ∞Ä nullÏù¥ ÏïÑÎãàÎùºÎ©¥ ÏöîÏ≤≠Î∞îÎîîÏóê Ìè¨Ìï®
        // nullÏù¥Î©¥ Ìè¨Ìï®ÌïòÏßÄÏïäÍ≥† AIÏöîÏ≤≠
        const requestBody = {
            dailyStudyEssayQuizLogNo: essayQuizLogNo, // nullÏù¥Î©¥ Ìè¨Ìï®ÎêòÏßÄ ÏïäÏùå
            dailyStudyEssayQuizNo: essayQuizNo,
            userAnswer: userAnswer
        };

        $.ajax({
            url: '/api/studies/essays/ai',
            method: 'PUT',
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify(requestBody),
            success: function(res) {
                console.log(res);

                renderAiFeedback(res.data);
            },
            error: function(err) {
                alert('ÌîºÎìúÎ∞± ÏÉùÏÑ±Ïóê Ïã§Ìå®ÌñàÏñ¥Ïöî, Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî');
            }
        })
    })

    /**
     * Ï†ÄÏû•ÌïòÍ∏∞ Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå ÎèôÏûëÌïòÎäî Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Î©îÏÜåÎìú
     */
    $('#essay-save-btn').click(function() {
        const userAnswer = $answerInput.val().trim();
        if (!userAnswer) {
            alert('ÎãµÎ≥ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.')
            return;
        }

        // essayQuizLogNoÍ∞Ä nullÏù¥Î©¥ ÏÉùÏÑ± ÏöîÏ≤≠ Ìò∏Ï∂ú,
        // nullÏù¥ ÏïÑÎãàÎ©¥ ÏÑúÏà†ÌòïÌÄ¥Ï¶à Ïù¥Î†• ÏàòÏ†ï ÏöîÏ≤≠ Ìò∏Ï∂ú
        const isUpdate = (essayQuizLogNo != null);
        const url = isUpdate ? `/api/studies/essays/logs/${essayQuizLogNo}` : `/api/studies/essays/logs`;
        const method = isUpdate ? 'PUT' : 'POST';
        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify({
                dailyStudyEssayQuizNo: essayQuizNo,
                userAnswer : userAnswer
            }),
            success: function(res) {
                alert('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
                console.log(res);

                // ÏÉàÎ°úÏÉùÏÑ±Îêú ÏÑúÏà†Ìòï Ïù¥Î†•Ïù¥Î©¥ Í∑∏ ÏãùÎ≥ÑÏûê Î≤àÌò∏Î•º JS Î≥ÄÏàòÏóê Ï†ÄÏû•
                essayQuizLogNo = essayQuizLogNo != null ? essayQuizLogNo : res.dailyStudyEssayQuizLogNo;
            }
        })
    })

    /**
     * AI ÌîºÎìúÎ∞±ÏùÑ Î†åÎçîÎßÅÌïòÎäî Ìï®Ïàò
     * @param data
     * data ÌòïÏãù
     * "sections": [
     *       {
     *         "type": "summary",
     *         "title": "Ï¥ùÌèâ",
     *         "items": [
     *           {
     *             "extra": {"icon": 'üëç'},
     *             "text": "ÎãµÎ≥ÄÏù¥ Îß§Ïö∞ ÏßßÍ≥†, Î¨∏Ï†úÏóêÏÑú ÏöîÍµ¨ÌïòÎäî ÎÇ¥Ïö©ÏùÑ Í±∞Ïùò Ìè¨Ìï®ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§. 'ÏóêÎ∏åÎ¶¨ÏîΩ ÏóêÎ∏åÎ¶¨Ïõê Ïò¨ Ïï≥ ÏõêÏä§'ÎùºÎäî Ï¢ãÏïÑÌïòÎäî ÏòÅÌôîÎ•º Ï†úÏãúÌñàÏßÄÎßå, Îì±Ïû•Ïù∏Î¨º, ÏÇ¨Í±¥, ÏãúÍ∞Ñ ÏàúÏÑúÎåÄÎ°ú Ï†ïÎ¶¨ÌïòÎäî Î∞©Î≤ïÏùÑ ÏÑ§Î™ÖÌïòÎäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏòÅÌôîÏùò ÏàúÏÑúÎ•º Î™®Î•∏Îã§Îäî Ï†êÏùÑ ÏÜîÏßÅÌïòÍ≤å Î∞ùÌòîÏßÄÎßå, Î¨∏Ï†ú Ìï¥Í≤∞ÏùÑ ÏúÑÌïú Ï∂îÍ∞ÄÏ†ÅÏù∏ ÎÖ∏Î†•Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§."
     *           }
     *         ]
     *       },
     *     ]
     */
    function renderAiFeedback(data) {
        $aiFeedbackContainer.empty();

        data.sections.forEach((section, idx) => {
            let itemHtml = '';
            section.items.forEach(item => {
                if(item.text != null) {
                    itemHtml += `<div>
                        ${item.text}
                    </div>`;
                }
            })

            const sectionHtml = `
                <div class="component essay_feedback_box">
                    <div class="title">
                        ${section.title}
                    </div>
                    ${itemHtml}
                </div>
            `;

            // Î¨∏ÏûêÏó¥ÏùÑ jQuery Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
            const $sectionEl = $(sectionHtml);

            // CSS Î≥ÄÏàò --delayÎ°ú Ïπ¥ÎìúÎ≥Ñ ÎîúÎ†àÏù¥ ÏßÄÏ†ï (0s, 1s, 2s...)
            $sectionEl.css('--delay', `${idx * 1}s`);

            // DOMÏóê Ï∂îÍ∞Ä
            $aiFeedbackContainer.append($sectionEl);

            // Í∞ïÏ†ú Î¶¨ÌîåÎ°úÏö∞
            // jQueryÍ∞ùÏ≤¥ÏóêÏÑú [0]ÏùÄ ÏàúÏàò DOM Element
            // .offsetHeightÎäî DOMÏöîÏÜåÏùò Î†åÎçîÎßÅÎêú ÎÜíÏù¥Î•º ÌîΩÏÖÄÎã®ÏúÑÎ°ú Î∞òÌôò
            // Ïó¨Í∏∞ÏÑú Í∞íÏùÑ ÏùΩÎäî Í≤É ÏûêÏ≤¥Î°ú ÏßÄÍ∏àÍπåÏßÄÏùò Î™®Îì† Ïä§ÌÉÄÏùº Í≥ÑÏÇ∞Í≥º Î†àÏù¥ÏïÑÏõÉ ÏûëÏóÖÏù¥ ÏôÑÎ£åÎê®
            // Î∏åÎùºÏö∞Ï†ÄÍ∞Ä revealÏù¥ Î∞òÏòÅÎêòÏßÄ ÏïäÏùÄ Ï¥àÍ∏∞ÏÉÅÌÉúÏùò ÏöîÏÜåÎ•º ÌôîÎ©¥Ïóê Î®ºÏ†Ä Î∞òÏòÅÌïòÎèÑÎ°ù Ìï®
            $sectionEl[0].offsetHeight;

            // ÌÅ¥ÎûòÏä§ Î∂ÄÏó¨Î°ú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
            $sectionEl.addClass('reveal');
        })
    }

    /*]]>*/
</script>

</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/center}">

<!--/* 학습 진행화면에서 표시할 네비바 */-->
<div id="study-nav-fragment" layout:fragment="fixed-nav-fragment">
    <div th:replace="~{fragments/common/study-nav :: study-nav-fragment(data=${data})}"></div>
</div>

<div layout:fragment="content">

    <!-- 학습진행바 -->
    <div class="level_info study_progress">
        <div class="bar_gauge">
            <!--/* 퀴즈는 항상 4개 */-->
            <div class="gauge"></div>
            <div class="marker">
                <div class="line"></div>
                <div class="label">퀴즈</div>
            </div>
        </div>
    </div>

    <!-- 학습 카드 -->
    <div id="main-study-content">
        <div class="component study_progress_card">
            <div class="title">학습제목</div>
            <div class="paragraph">학습내용 paragraph</div>
            <div class="example">학습내용예시 example</div>
            <div class="definition">학습내용정의 definition</div>
            <div class="quote">학습내용인용 quote</div>
            <div class="list">학습내용리스트 list</div>
        </div>
        <!--    <th:block th:each="card : ${data.cards}">-->
        <!--      <p th:text="${card.cardIndex}"></p>-->
        <!--      <p th:text="${card.content}"></p>-->
        <!--      <p th:text="${card.dailyStudyCardNo}"></p>-->
        <!--    </th:block>-->
    </div>

    <!-- 카드 넘기는 버튼 -->
    <div class="btn_list daily_study">
        <button class="btn white" id="prev-btn">이전</button>
        <button class="btn white" id="next-btn">다음</button>
    </div>

</div>

<script layout:fragment="script" th:inline="javascript">
    /*<![CDATA[*/

    // 백엔드 서버에서 전달된 data.cards 객체 리스트를 자바스크립트 변수로 바인딩
    // 자동으로 JSON.stringify()되어 들어간다
    let cards = /*[[${data.cards}]]*/ [];
    let dailyStudy = /*[[${data.dailyStudy}]]*/ {};
    let studyLog = /*[[${data.log}]]*/ {};
    let studyLogNo = studyLog && studyLog.dailyStudyLogNo ? studyLog.dailyStudyLogNo : '';
    let quizzes = /*[[${data.quizzes}]]*/ [];
    let quizLogs = /*[[${data.quizLogs}]]*/ [];
    console.log(cards);
    let currentIndex = studyLog && studyLog.studiedCardCount !== 0 ? studyLog.studiedCardCount : 0;
    console.log("currentIndex: "+ currentIndex);
    // 개수 계산
    const cardCount = cards.length;
    const quizCount = quizzes.length;
    // 그 외의 info 카드 개수
    const startInfoCount = 1;      // 인덱스 0
    const quizInfoCount = 1;       // 카드 끝난 직후
    const lastInfoCount = 1;      // 마지막
    // 전체 화면 개수
    const totalCount = cardCount + quizCount + startInfoCount + quizInfoCount + lastInfoCount;
    // 인덱스 계산
    const cardLastIndex = startInfoCount + cardCount - 1;
    const quizInfoIndex = cardLastIndex + 1; // 퀴즈 안내 화면 인덱스
    const quizStartIndex = quizInfoIndex + 1;

    console.log(totalCount);
    console.log('studyLog : ' + studyLog);
    console.log(quizzes);

    const $prevBtn = $('#prev-btn');
    const $nextBtn = $('#next-btn');
    const $navListItem = $('.study_nav_list_item');
    // 전체 카드 콘텐츠를 담을 컨테이너
    const $mainContentContainer = $('#main-study-content');

    // 화면이 렌더링될 때 한 번 실행할 함수들
    $(document).ready(function() {
        renderContent();
        updateOrCreateLog();
        renderQuizMarkerPosition(); // ← quiz_marker 위치 설정
    });

    /**
     * 렌더링 시점에 퀴즈 마커의 위치를 정하는 함수
     */
    function renderQuizMarkerPosition() {
        const $quizMarker = $('.marker');

        const progressStepCount = totalCount - 1; // 진행률 기준 칸 수 (startInfo 제외)
        const markerPercent = (quizInfoIndex / progressStepCount) * 100;

        $quizMarker.css('left', markerPercent + '%');
    }

    /**
     * 화면 렌더링 시점에 학습이력 존재 여부에 따라 학습이력 생성/수정 요청
     */
    function updateOrCreateLog() {
        // SSR로 넘겨받은 이력정보가 없으면, 이력 생성요청
        if (!studyLog) {
            $.ajax({
                url: `/api/studies/logs`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    "dailyStudyNo": dailyStudy.dailyStudyNo
                }),
                dataType: 'json',
                success: function (res) {
                    console.log('학습 이력 생성 성공:', res);
                    studyLog = res.data; // 전역 변수 갱신
                    studyLogNo = res.data.dailyStudyLogNo; // 전역 변수 갱신
                },
                error: function (err) {
                    console.error('학습 이력 생성 실패:', err);
                }
            })
        }
            // 학습이력이 이미 존재하면, 이력 수정요청
        // request body 없이 전달해서 updatedDate만 수정
        else {
            $.ajax({
                url: `/api/studies/logs/${studyLogNo}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({}),
                dataType: 'json',
                success: function (res) {
                    console.log('학습 이력 업데이트 성공:', res);
                    studyLog = res.data; // 전역 변수 갱신
                    studyLogNo = res.data.dailyStudyLogNo; // 전역 변수 갱신
                },
                error: function (err) {
                    console.error('학습 이력 업데이트 실패:', err);
                }
            });
        }
    }

    /**
     * 강조 변환 함수 (마크다운 스타일 → HTML 태그)
     */
    function applyStrong(text) {
        if (typeof text !== 'string') return text;
        return text.replace(/\*\*(.+?)\*\*/g, '<strong class="strong">$1</strong>');
    }

    /**
     * 강조 변환 함수를 재귀적으로 모든 요소에 적용
     * @param content
     * @returns {*|{}}
     */
    function deepApplyStrong(content) {
        if (Array.isArray(content)) {
            // 배열이면 각 요소에 재귀 호출
            return content.map(item => deepApplyStrong(item));
        } else if (typeof content === 'object' && content !== null) {
            // 객체면 모든 key를 순회하면서 재귀 호출
            const newObj = {};
            for (const key in content) {
                newObj[key] = deepApplyStrong(content[key]);
            }
            return newObj;
        } else {
            // 문자열 또는 기타 타입일 경우
            return applyStrong(content);
        }
    }

    /**
     * 현재 인덱스에 해당하는 학습 카드를 화면에 렌더링하는 함수
     */
    function renderCard(index) {
        // 전체 카드 콘텐츠를 담을 컨테이너의 기존 내용 초기화
        $mainContentContainer.empty();
        // 카드 제목, 내용등의 텍스트를 담을 최상위 div
        const $studyCardDiv = $('<div>').addClass('component study_progress_card');

        // 현재 인덱스의 카드 데이터 추출
        const card = cards[index];
        let content = JSON.parse(card.content); // JSON 문자열형식의 content를 JSON으로 파싱

        // 강조 변환 처리 (** -> <strong>)
        content = deepApplyStrong(content);

        // 현재 카드의 제목을 title 스타일을 가진 div 태그로 렌더링
        const $titleDiv = $('<div>').addClass('title').text(card.title);
        $studyCardDiv.append($titleDiv);

        // 현재 카드의 내용 (JSON 리스트)를 순회하면서 타입에 따라 다른 태그로 렌더링
        content.forEach(item => {
            const $div = $('<div>').addClass(item.type); // div태그를 하나 만들고, 타입에 맞는 클래스 부여

            // paragraph이면 기본 p태그 삽입
            if (item.type === 'paragraph') {
                $div.html(`<p>${item.content}</p>`);
            }
            // quote 타입이면 인용
            else if (item.type === 'quote') {
                const quoteStyled = item.content.replace(/[“”"]/g, '<span class="double_quote">$&</span>');
                console.log(quoteStyled);

                // HTML에 그대로 출력 (큰따옴표 유지)
                $div.html(`<blockquote class="custom_quote">
                                ${quoteStyled}
                            </blockquote>`);
            }
            // list 타입이면 content가 리스트 형식이므로 순회하면서 ul태그내에 li로 삽입
            else if (item.type === 'list') {
                const $ul = $('<ul class="custom_list">');
                item.content.forEach(((text, idx) => {
                    // li 태그 생성
                    const $li = $('<li class="custom_list_item">').html(text).attr('data-index', idx + 1);

                    $ul.append($li);
                }));
                $div.append($ul);
            }
            // definition 타입이면 : 기준으로 정의와 설명을 구분
            else if (item.type === 'definition') {
                // ':' 또는 '.' 둘 중 하나로 split
                const parts = item.content.split(/[:.]/);

                // 빈 문자열 제거
                const cleanedParts = parts.map(p => p.trim()).filter(p => p.length > 0);

                // 만약 definition 타입의 content에 :가 없는 경우
                let html = '';
                cleanedParts.forEach((part, index) => {
                    if (index % 2 === 0) {
                        // 짝수 인덱스: 용어
                        html += `<strong class="definition_term">${part}</strong>`;
                    } else {
                        // 홀수 인덱스: 설명 (앞에 구분자 추가)
                        html += `: ${part}<br>`;
                    }
                });
                $div.html(`<p>${html}</p>`);
            }
            // example 타입이면 텍스트앞에 '예시' 문구 추가
            else if (item.type === 'example') {
                $div.html(`<p>
                                <strong class="example_label">
                                    예시
                                </strong>: ${item.content}
                            </p>`);
            }
            // table 타입이면 표 추가구현
            else if (item.type === 'table') {
                // 2차원 배열 형식
                const tableData = item.content;

                // HTML 문자열 구성
                let tableHtml = `<table class="study_table">`;

                // 첫 번째 행을 thead로
                if (tableData.length > 0) {
                    tableHtml += `<thead><tr>`;
                    tableData[0].forEach(header => {
                        tableHtml += `<th>${header}</th>`;
                    });
                    tableHtml += `</tr></thead>`;
                }

                // 나머지 행을 tbody로
                if (tableData.length > 1) {
                    tableHtml += `<tbody>`;
                    for (let i = 1; i < tableData.length; i++) {
                        tableHtml += `<tr>`;
                        tableData[i].forEach(cell => {
                            tableHtml += `<td>${cell}</td>`;
                        });
                        tableHtml += `</tr>`;
                    }
                    tableHtml += `</tbody>`;
                }
                tableHtml += `</table>`;

                $div.html(tableHtml);
            }

            // 적절한 HTML가 적용된 div를 allContentDiv(텍스트용 컨테이너)에 append
            $studyCardDiv.append($div);
        });

        // allContentDiv를 카드 전체 컨테이너에 append
        $mainContentContainer.append($studyCardDiv);
    }

    /**
     * 현재 인덱스에 맞는 퀴즈를 렌더링하는 함수
     * 현재 퀴즈에 대한 사용자의 학습 이력이 존재하면, 그것도 고려
     */
    function renderQuiz(index) {
        // 컨테이너 초기화
        $mainContentContainer.empty();

        const quiz = quizzes[index];
        let quizLog = null;
        let studyQuizLogNo = null;

        // 해당 퀴즈에 대한 퀴즈 이력이 있는지 확인 및 추출
        quizLogs.forEach(log => {
            if (log.dailyStudyQuizNo === quiz.dailyStudyQuizNo) {
                quizLog = log;
            }
        });
        console.log('quiz : ' + quiz);
        console.log('quizLog : ' + quizLog);

        // 보기목록 컨텐츠 구성
        let optionHtml = '';
        for (let i = 1; i <= 4; i++) {
            const optionNumber = quiz[`option${i}`];
            let isLogSelected = false;
            if (quizLog) {
                isLogSelected = (quizLog.selectedChoice === i);
                studyQuizLogNo = quizLog.dailyStudyQuizLogNo;
            }
            optionHtml += `
        <div class="component study_quiz_option ${isLogSelected ? 'selected' : ''}"
        data-option-number="${i}">
          ${i}. ${optionNumber}
        </div>
      `;
        }

        let quizHtml = `
      <div class="study_quiz_wrapper" id="quiz-container"
        data-study-quiz-no="${quiz.dailyStudyQuizNo}"
        data-study-quiz-log-no="${studyQuizLogNo !== null ? studyQuizLogNo : ''}">
      <!-- 퀴즈 번호 및 제목 -->
      <div class="study_quiz_info">
        <span class="study_quiz_number">${currentIndex + 1}</span>
        <span class="study_quiz_text">문제</span>
      </div>

      <!-- 문제 박스 -->
      <div class="study_quiz_box">
        ${quiz.question}
      </div>

      <!-- 보기 리스트 -->
      <div class="study_quiz_option_wrapper">
        <div class="study_quiz_info">
          <div class="icon_btn">
            <iconify-icon icon="icon-park:check-one"></iconify-icon>
          </div>
          <span class="study_quiz_text">보기</span>
        </div>
      </div>
      <div class="study_quiz_option_list">
        ${optionHtml}
      </div>

      <!-- 정답 제출 버튼 -->
      <button type="button" class="btn primary study_quiz_submit_btn disabled" id="quiz-submit-btn">정답 제출</button>
    </div>
    `;

        $mainContentContainer.append(quizHtml);
    }

    /**
     * 학습 정보와 관련된 추가 화면을 렌더링하는 함수
     * @param type
     */
    function renderInfoCard(type) {
        // 전체 카드 콘텐츠를 담을 컨테이너의 기존 내용 초기화
        $mainContentContainer.empty();
        // 카드 제목, 내용등의 텍스트를 담을 최상위 div
        const $studyCardDiv = $('<div>').addClass('component study_progress_card center');

        let html = '';

        switch (type) {
            case 'start':
                html = `
                    <div class="info">오늘의 학습을 시작해볼까요?</div>
                    <div class="title">${dailyStudy.title}</div>
                    <div class="paragraph">${dailyStudy.explanation ? dailyStudy.explanation : ''}</div>
                `;
                break;
            case 'quiz':
                html = `
                    <div class="info">학습을 마쳤으니 퀴즈를 풀어볼까요?</div>
                `;
                break;
            case 'last':
                html = `
                    <div class="info">학습을 완료하였습니다!</div>
                `;
                break;
        }

        $studyCardDiv.html(html);
        $mainContentContainer.append($studyCardDiv);
    }

    /**
     *
     */
    $prevBtn.click(() => {
        $nextBtn.removeClass('blink');

        if ( currentIndex > 0 ) {
            currentIndex -= 1;
            console.log(currentIndex);
            renderContent();
        }
    });

    /**
     *
     */
    $nextBtn.click(() => {
        $nextBtn.removeClass('blink');

        // 마지막 인덱스 전까지
        if (currentIndex < totalCount - 1) {
            currentIndex += 1;
            console.log('currentIndex: ' + currentIndex);
            renderContent();

            // 현재 인덱스가 학습이력의 학습카드개수를 넘으면 학습이력 업데이트
            if (currentIndex <= cardLastIndex && currentIndex > studyLog.studiedCardCount - 1) {
                const updateStudiedCartCount = currentIndex - 1 + startInfoCount;
                $.ajax({
                    url: `/api/studies/logs/${studyLogNo}`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        "studiedCardCount": updateStudiedCartCount
                    }),
                    dataType: 'json',
                    success: function (res) {
                        console.log('학습 이력 학습카드개수 업데이트 성공: '+ res.data.studiedCardCount);
                        // js 전역객체 갱신
                        studyLog.studiedCardCount = res.data.studiedCardCount;
                    }
                });
            }
        }
        // 마지막 인덱스면 이력업데이트 및 학습끝내기
        else if (currentIndex === totalCount - 1) {
            $.ajax({
                url: `/api/studies/logs/${studyLogNo}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    "studiedCardCount": cardCount,
                    "status": "COMPLETED"
                }),
                dataType: 'json',
                success: function (res) {
                    console.log('학습 이력 업데이트 성공: ', res);

                    const isQuestCompleted = res.data.questCompleted;

                    // 학습 완료 페이지로 이동
                    window.location.href = `/study/${dailyStudy.dailyStudyNo}/complete?quest=${isQuestCompleted}`;
                },
                error: function (err) {
                    console.error('학습 이력 업데이트 실패 :', err);
                }
            });
        }
    })

    /**
     * currentIndex에 맞는 콘텐츠를 렌더링
     * - 현재 인덱스가 학습 카드 인덱스면 카드 렌더링
     * - 현재 인덱스가 퀴즈 인덱스면 퀴즈 렌더링
     * - renderBtn을 호출해 화면에 맞는 버튼 렌더링
     */
    function renderContent() {
        // 첫 인덱스일 경우, 첫화면 안내
        if (currentIndex === 0) {
            renderInfoCard('start');
        }
        // 현재 인덱스가 카드 마지막 인덱스 이하라면, 일반 학습 카드 렌더링
        else if (currentIndex <= cardLastIndex) {
            renderCard(currentIndex - 1); // currentIndex가 1일때 cards[0]
        }
        // 퀴즈 직전 화면
        else if (currentIndex === quizInfoIndex) {
            renderInfoCard('quiz');
        }
        // 현재 인덱스가 카드 마지막 인덱스를 초과하고 , 일반 학습 퀴즈 렌더링
        else if (currentIndex < totalCount - 1) {
            // 총 카드가 3개고 currentIndex가 5면 quizzes[0] 렌더링
            renderQuiz(currentIndex - quizStartIndex);
        }
        // 마지막 인덱스 (퀴즈 포함 전체 마지막)
        else if (currentIndex === totalCount - 1) {
            renderInfoCard('last');
        }
        renderBtn();
        renderProgressBar();
        renderNav();
    }

    /**
     * 인덱스에 맞는 버튼 렌더링
     */
    function renderBtn() {
        $nextBtn.removeClass("study_end_btn");

        // prevBtn 변경
        if (currentIndex === 0) {
            $prevBtn.prop('disabled', true); // 첫 화면이면 비활성화
        } else {
            $prevBtn.prop('disabled', false);
        }

        // nextBtn변경
        // 다음 인덱스가 퀴즈 시작 인덱스인 경우
        if (currentIndex === cardLastIndex) {
            $nextBtn.removeClass("white");
            $nextBtn.addClass("primary");
            $nextBtn.text("퀴즈 풀러가기");
        }
        // 다음 인덱스가 마지막 인덱스인 경우
        else if (currentIndex === totalCount - 1) {
            $nextBtn.removeClass("white");
            $nextBtn.addClass("primary");
            $nextBtn.addClass("study_end_btn");
            $nextBtn.text("학습 끝내기");
        } else {
            $nextBtn.removeClass("primary");
            $nextBtn.addClass("white");
            $nextBtn.text("다음");
        }
    }

    /**
     * 퀴즈 제출 버튼 클릭시 발생하는 이벤트
     */
    $(document).on('click', '#quiz-submit-btn', function () {
        const $quizContainer = $('#quiz-container');
        const studyQuizNo = $quizContainer.attr('data-study-quiz-no');
        const studyQuizLogNo = $quizContainer.attr('data-study-quiz-log-no');
        const selectedChoice = $('.study_quiz_option.selected').attr('data-option-number');
        console.log(studyQuizNo, selectedChoice);

        // 이미 퀴즈 이력이 존재하면 수정요청
        if (studyQuizLogNo && studyQuizLogNo !== '') {
            $.ajax({
                url: `/api/studies/quizzes/logs/${studyQuizLogNo}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    "selectedChoice": selectedChoice
                }),
                dataType: 'json',
                success: function (res) {
                    console.log('퀴즈 수정 성공:', res);
                    const updatedLog = res.data;

                    // quizLogs에서 해당 로그를 찾아 업데이트
                    const indexToUpdate = quizLogs.findIndex(
                        log => log.dailyStudyQuizLogNo === updatedLog.dailyStudyQuizLogNo);
                    if (indexToUpdate !== -1) {
                        quizLogs[indexToUpdate] = updatedLog;
                    }

                    // 사용자의 정답/오답 여부에 따라 selected된 보기에 스타일 추가
                    markQuizResult(updatedLog.isSuccess);
                    // 사용자의 정답/오답 여부에 따라 네비바 목록에 아이콘 추가
                    updateQuizNavIcon(studyQuizNo, updatedLog.isSuccess);
                },
                error: function (err) {
                    console.error('퀴즈 수정 실패:', err);
                }
            });
        }
        // 퀴즈 이력이 없으면 생성요청 및 quizLogs에 생성된 퀴즈 이력 추가
        else {
            $.ajax({
                url: '/api/studies/quizzes/logs',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    "dailyStudyQuizNo": studyQuizNo,
                    "selectedChoice": selectedChoice
                }),
                dataType: 'json',
                success: function (res) {
                    const newLog = res.data;
                    console.log(res.data);
                    // quizLogs에 넣어야 이 퀴즈화면이 다시 렌더링될 때 이력을 표시할 수 있음
                    quizLogs.push(newLog);
                    // 퀴즈컨테이너의 이력번호 속성도 변경해야 다시 요청보냈을 때 생성대신 수정 요청 전달 가능
                    $quizContainer.attr('data-study-quiz-log-no', newLog.dailyStudyQuizLogNo);

                    // 사용자의 정답/오답 여부에 따라 selected된 보기에 스타일 추가
                    markQuizResult(newLog.isSuccess);
                    // 사용자의 정답/오답 여부에 따라 네비바 목록에 아이콘 추가
                    updateQuizNavIcon(studyQuizNo, newLog.isSuccess);
                },
                error: function (err) {
                    console.error('퀴즈 생성 실패:', err);
                }
            });
        }
    });

    /**
     * 퀴즈 제출 후 네비바에 아이콘 업데이트
     */
    function updateQuizNavIcon(quizNo, isSuccess) {
        const $quizNavItem = $(`.study_nav_list_item[data-quiz-no="${quizNo}"]`);
        $quizNavItem.find('.study_item_icon').remove(); // 기존 아이콘 제거

        let iconHtml = '';

        if (isSuccess === 'Y') {
            iconHtml = `
                <span class="study_item_icon icon_pop">
                    <iconify-icon style="color: var(--primaryColor)" icon="rivet-icons:circle"></iconify-icon>
                </span>`;
        } else if (isSuccess === 'N') {
            iconHtml = `
                <span class="study_item_icon icon_pop">
                    <iconify-icon icon="emojione-v1:cross-mark"></iconify-icon>
                </span>`;
        }

        $quizNavItem.append(iconHtml);
    }


    /**
     * 퀴즈 렌더링 화면에서 option 버튼 클릭시 selected 되도록
     */
    $(document).on('click', '.study_quiz_option', function () {
        console.log('study_quiz_option 선택');
        $(this).siblings().removeClass('selected');
        $(this).addClass('selected');
        $('#quiz-submit-btn').removeClass('disabled');
    });

    /**
     * isSuccess 여부로 현재 selected된 보기에 오답/정답 스타일 추가하는 함수
     */
    function markQuizResult(isSuccess) {
        // 모든 보기에서 기존 정답/오답 스타일 제거
        $('.study_quiz_option').removeClass('wrong correct');

        // 사용자가 선택한 보기가 정답이면
        if (isSuccess === 'Y') {
            $('.study_quiz_option.selected').addClass('correct');
            $nextBtn.addClass('blink');

        } else if (isSuccess === 'N') {
            $('.study_quiz_option.selected').addClass('wrong');
            $nextBtn.removeClass('blink');
        }
    }

    /**
     * 현재 인덱스에 맞게 학습 진행바를 렌더링하는 함수
     * quiz 안내 화면은 화면이긴 하지만 진행률 전체 구간 수에도 포함하지 않음
     */
    function renderProgressBar() {
        $experiencePoint = $('.gauge');

        const progressStepCount = totalCount - 1; // startInfo 화면만 제외
        let progressStepIndex = currentIndex // 진행률 계산용 인덱스

        // 시작화면 : 진행도 0%
        if (currentIndex === 0) {
            $experiencePoint.css('width', '0%');
            $experiencePoint.removeClass('after_quiz');
            return;
        }

        // 진행률 계산
        const progressPercent = (progressStepIndex / progressStepCount) * 100;
        $experiencePoint.css('width', progressPercent  + '%');

        // 현재 인덱스가 카드 인덱스라면 클래스 추가해서 진행바 색상 변경
        if (currentIndex >= quizInfoIndex) {
            $experiencePoint.addClass('after_quiz');
        } else {
            $experiencePoint.removeClass('after_quiz');
        }
    }

    /**
     * 네비바 렌더링
     */
    function renderNav() {
        $navListItem.removeClass('active');
        let $activeCard;

        if (currentIndex >= quizStartIndex) {
            $activeCard = $(`.study_nav_list_item[data-quiz-index=${currentIndex - quizStartIndex + 1}]`);
        } else {
            $activeCard = $(`.study_nav_list_item[data-card-index=${currentIndex}]`);

            // 아이콘이 없으면
            if ($activeCard.find('.study_item_icon').length === 0) {
                const iconHtml = `
                    <span class="study_item_icon ">
                        <iconify-icon icon="icon-park-solid:check-one"></iconify-icon>
                    </span>`;

                $activeCard.append(iconHtml);
            }
        }

        $activeCard.addClass('active');
    }

    /**
     * 네비바에서 특정 카드 목록을 눌렀을 때 동작할 이벤트 핸들러
     */
    $navListItem.click(function() {

        let targetIndex;

        // 학습 카드일 경우
        if ($(this).data('card-index') !== undefined) {
            targetIndex = parseInt($(this).data('card-index'));
        }
        // 퀴즈인 경우
        else if ($(this).data('quiz-index') !== undefined) {
            const quizIndex = parseInt($(this).data('quiz-index'));
            targetIndex = quizStartIndex + (quizIndex - 1);
        }

        // currentIndex를 변경한 후 렌더링
        currentIndex = targetIndex;
        renderContent();
    })


    /*]]>*/
</script>

</html>